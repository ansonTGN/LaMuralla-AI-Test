{% extends "base.html" %}

{% block content %}
<style>
    /* --- Estilos Chat RAG --- */
    
    /* Píldoras de Concepto (NUEVO DISEÑO) */
    .concept-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        color: #0369a1;
        border: 1px solid #bae6fd;
        border-radius: 9999px; /* Pill shape */
        padding: 2px 10px 2px 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none !important;
        margin: 0 2px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        user-select: none;
        white-space: nowrap;
    }

    .concept-pill:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }
    
    .concept-pill i { font-size: 0.75em; opacity: 0.8; }

    /* Referencias bibliográficas */
    .ref-link {
        font-size: 0.7em;
        color: #64748b;
        vertical-align: super;
        margin-left: 2px;
        font-family: 'Roboto Mono', monospace;
        cursor: help;
    }
    
    /* --- Estilos UI Generales --- */
    .modal-content { border-radius: 12px; }
    
    /* Logs de Ingestión */
    #progressLog div {
        margin-bottom: 2px;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 2px;
    }

    /* Pestañas */
    .nav-tabs .nav-link { color: #64748b; border: none; border-bottom: 2px solid transparent; }
    .nav-tabs .nav-link.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; background: transparent; }
    .nav-tabs .nav-link:hover { border-color: transparent; color: #3b82f6; }

    /* Estilos del Modal de Grafo (Deep Dive) */
    #conceptNetwork {
        width: 100%;
        height: 60vh; /* Altura adaptable */
        background: #0f172a; /* Fondo oscuro pro */
        border-radius: 0 0 8px 8px;
    }
    
    @media (max-width: 768px) {
        #conceptNetwork { height: 50vh; }
        .concept-pill { font-size: 0.75rem; padding: 2px 8px; }
    }
</style>

<!-- NAVBAR -->
<nav class="navbar navbar-dark px-4 shadow-sm">
    <a class="navbar-brand d-flex align-items-center gap-2 fw-bold" href="#">
        <i class="fa-solid fa-shield-halved text-info"></i> 
        <span>LA MURALLA <small class="opacity-50 font-monospace fs-6">RAG SYSTEM</small></span>
    </a>
    <div class="d-flex align-items-center gap-3">
        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2">
            <i class="fa-solid fa-circle fa-xs me-2"></i>SISTEMA ONLINE
        </span>
        <a href="/logout" class="btn btn-sm btn-outline-secondary text-white border-0"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- SIDEBAR IZQUIERDO -->
        <div class="col-md-4 col-lg-3 sidebar p-4 d-flex flex-column shadow-sm">
            
            <!-- SECCIÓN 1: INGESTIÓN -->
            <h5 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-database me-2"></i>Ingestión</h5>
            
            <div class="card border-0 shadow-sm mb-4">
                <!-- Pestañas -->
                <div class="card-header bg-white border-bottom-0 pt-3 px-0 mx-3">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active small fw-bold" id="tab-btn-text" data-bs-toggle="tab" data-bs-target="#tab-text">
                                <i class="fa-solid fa-pen-nib me-1"></i> Texto
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small fw-bold" id="tab-btn-file" data-bs-toggle="tab" data-bs-target="#tab-file">
                                <i class="fa-solid fa-file-arrow-up me-1"></i> Archivo
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body bg-light rounded-bottom">
                    <div class="tab-content mb-3">
                        <!-- Tab Texto -->
                        <div class="tab-pane fade show active" id="tab-text">
                            <textarea id="ingestContent" class="form-control border-0 shadow-none" rows="5" placeholder="Pega aquí textos legales, clínicos o técnicos..." style="resize: none; font-size: 0.9rem;"></textarea>
                        </div>
                        <!-- Tab Archivo -->
                        <div class="tab-pane fade" id="tab-file">
                            <div class="text-center p-4 border border-dashed rounded bg-white">
                                <div class="d-flex justify-content-center gap-3 mb-3 opacity-50">
                                    <i class="fa-solid fa-file-pdf fa-2x text-danger"></i>
                                    <i class="fa-solid fa-file-word fa-2x text-primary"></i>
                                    <i class="fa-solid fa-file-lines fa-2x text-secondary"></i>
                                </div>
                                <div class="small text-muted mb-3">Soporta: PDF, DOCX, TXT</div>
                                <input type="file" id="ingestFile" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>

                    <button onclick="startIngestion()" id="btnIngest" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">
                        <i class="fa-solid fa-microchip me-2"></i> PROCESAR
                    </button>
                </div>
            </div>

            <!-- Área de Progreso (Oculta por defecto) -->
            <div id="progressArea" class="d-none mb-4">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small fw-bold text-muted">Estado del Proceso</span>
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
                <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
                <div id="progressLog" class="small font-monospace text-muted p-2 bg-white border rounded shadow-sm" style="max-height: 120px; overflow-y: auto; font-size: 0.75rem;"></div>
            </div>

            <!-- SECCIÓN 2: RAZONAMIENTO -->
            <hr class="my-4">
            <h5 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-brain me-2"></i>Razonamiento</h5>
            <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
                <div class="card-body">
                    <p class="small text-muted mb-2 lh-sm">
                        Detecta conexiones lógicas ocultas entre documentos dispares.
                    </p>
                    <button onclick="runReasoning()" id="btnReasoning" class="btn btn-warning text-dark w-100 fw-bold py-2 shadow-sm border border-warning">
                        <i class="fa-solid fa-lightbulb me-2"></i> CONSOLIDAR GRAFO
                    </button>
                    <div id="reasoningResult" class="mt-2 small text-center d-none"></div>
                </div>
            </div>

            <!-- FOOTER INFO -->
            <div class="mt-auto pt-4">
                <div class="alert alert-info border-0 d-flex align-items-center small mb-0" role="alert">
                    <i class="fa-solid fa-circle-info me-2 fs-4"></i>
                    <div>
                        <strong>Motor Activo</strong><br>
                        Modelo: {{ config.model_name }}<br>
                        Embeddings: {{ config.embedding_dim }} dims
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN: GRAFO GLOBAL -->
        <div class="col-md-8 col-lg-9 main-content">
            <div id="network-container"></div>
            
            <!-- Controles Flotantes -->
            <div class="position-absolute bottom-0 end-0 m-4 d-flex gap-2" style="margin-bottom: 90px !important;">
                <button class="btn btn-dark border border-secondary shadow" onclick="reloadGraph()" title="Recargar Grafo">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button class="btn btn-dark border border-secondary shadow" onclick="network.fit({animation:true})" title="Centrar">
                    <i class="fa-solid fa-compress"></i>
                </button>
            </div>

            <!-- Leyenda -->
            <div class="position-absolute top-0 start-0 m-4 p-3 bg-dark bg-opacity-75 rounded text-white small pointer-events-none backdrop-blur">
                <div class="fw-bold mb-2 text-uppercase opacity-75">Leyenda</div>
                <div class="d-flex align-items-center gap-2 mb-1"><span class="badge bg-primary rounded-circle p-1"> </span> Entidad</div>
                <div class="d-flex align-items-center gap-2"><span class="badge bg-warning rounded-circle p-1"> </span> Concepto</div>
            </div>
        </div>
    </div>
</div>

<!-- BOTÓN FLOTANTE CHAT -->
<button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
        style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 1050; transition: transform 0.2s;"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"
        data-bs-toggle="modal" data-bs-target="#chatModal" title="Asistente RAG">
    <i class="fa-solid fa-robot fa-xl"></i>
</button>

<!-- MODAL CHAT -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
            <div class="modal-header bg-dark text-white py-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-brain text-info"></i>
                    <h5 class="modal-title fw-bold fs-6">Asistente GraphRAG</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light d-flex flex-column p-0">
                <div id="chatArea" class="flex-grow-1 overflow-auto p-4">
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-white text-dark border rounded p-3 shadow-sm" style="max-width: 85%;">
                            <div class="fw-bold small text-primary mb-1"><i class="fa-solid fa-robot me-1"></i> Sistema</div>
                            Hola. Hazme preguntas sobre tus documentos. Puedo conectar conceptos del grafo para darte respuestas más completas.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer p-3 bg-white border-top">
                <div class="input-group">
                    <input type="text" id="userPrompt" class="form-control border bg-light" placeholder="Pregunta algo..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary px-4 fw-bold" onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE INSPECCIÓN DE CONCEPTO (Deep Dive) -->
<div class="modal fade" id="conceptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-2xl overflow-hidden">
            <!-- Header con gradiente -->
            <div class="modal-header py-3" style="background: linear-gradient(to right, #1e293b, #0f172a); border-bottom: 1px solid #334155;">
                <div class="d-flex align-items-center gap-3 text-white">
                    <div class="bg-primary rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="fa-solid fa-project-diagram"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold mb-0" id="conceptModalTitle">Cargando...</h5>
                        <small class="text-secondary" style="font-size: 0.75rem;">RELACIONES ESTRUCTURALES</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle text-white" type="button" data-bs-toggle="dropdown">
                            <i class="fa-solid fa-download me-1"></i> Exportar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><a class="dropdown-item small" href="#" onclick="exportSubGraph('json')"><i class="fa-solid fa-code me-2"></i>JSON</a></li>
                            <li><a class="dropdown-item small" href="#" onclick="exportSubGraph('csv')"><i class="fa-solid fa-table me-2"></i>CSV (Nodos)</a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <!-- Cuerpo Visual -->
            <div class="modal-body p-0 bg-dark position-relative">
                <div id="conceptNetwork"></div>
                
                <!-- Loading Overlay interno -->
                <div id="conceptLoading" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-dark bg-opacity-75" style="z-index: 10;">
                    <div class="spinner-border text-info mb-2" role="status"></div>
                    <span class="text-white small tracking-wider">MAPEANDO CONEXIONES...</span>
                </div>

                <!-- Floating Controls -->
                <div class="position-absolute bottom-0 start-0 m-3 p-2 bg-black bg-opacity-50 rounded text-white small font-monospace">
                    <i class="fa-solid fa-circle text-warning me-1"></i> Central
                    <i class="fa-solid fa-circle text-primary ms-2 me-1"></i> Relacionado
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- VARIABLES GLOBALES ---
    let network; // Grafo principal
    let conceptNetworkInstance = null; // Sub-grafo modal
    let currentSubGraphData = null; // Datos para exportación

    // Carga inicial
    document.addEventListener('DOMContentLoaded', () => { loadGraph(); });

    // --- 1. LÓGICA DE INGESTIÓN (Streaming & Archivos) ---
    async function startIngestion() {
        const btn = document.getElementById('btnIngest');
        const progressArea = document.getElementById('progressArea');
        const logDiv = document.getElementById('progressLog');
        const fileInput = document.getElementById('ingestFile');
        const textInput = document.getElementById('ingestContent');
        
        const formData = new FormData();
        let hasData = false;
        
        const isTextActive = document.getElementById('tab-btn-text').classList.contains('active');

        if (isTextActive) {
            if (textInput.value.trim().length > 0) {
                formData.append('content', textInput.value);
                hasData = true;
            }
        } else {
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
                hasData = true;
            }
        }

        if(!hasData) return alert("Por favor, selecciona un archivo o escribe un texto válido.");

        btn.disabled = true;
        progressArea.classList.remove('d-none');
        logDiv.innerHTML = '<div class="text-primary"><i class="fa-solid fa-satellite-dish me-2"></i>Conectando con el motor...</div>';
        
        try {
            const response = await fetch('/api/ingest', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Server error: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if(!line.trim()) continue;
                    
                    if(line.includes("DONE")) {
                        logDiv.innerHTML += `<div class="text-success fw-bold mt-2"><i class="fa-solid fa-check-circle me-2"></i>Proceso Completado.</div>`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                        await loadGraph(); 
                        setTimeout(() => {
                            progressArea.classList.add('d-none');
                            btn.disabled = false;
                            textInput.value = "";
                            fileInput.value = "";
                            logDiv.innerHTML = "";
                        }, 3000);
                        return;
                    } else if (line.includes("Error")) {
                        logDiv.innerHTML += `<div class="text-danger fw-bold"><i class="fa-solid fa-triangle-exclamation me-2"></i>${line}</div>`;
                    } else {
                        logDiv.innerHTML += `<div><i class="fa-solid fa-caret-right me-2 opacity-50"></i>${line}</div>`;
                    }
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            }
        } catch(e) {
            console.error(e);
            logDiv.innerHTML += `<div class="text-danger fw-bold mt-2">Error de conexión: ${e.message}</div>`;
            btn.disabled = false;
        }
    }

    // --- 2. LÓGICA DE RAZONAMIENTO ---
    async function runReasoning() {
        const btn = document.getElementById('btnReasoning');
        const resDiv = document.getElementById('reasoningResult');
        
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Pensando...';
        
        resDiv.classList.remove('d-none');
        resDiv.className = 'mt-2 small text-muted text-center';
        resDiv.innerHTML = 'Analizando relaciones latentes...';
        
        try {
            const res = await fetch('/api/reasoning/run', { method: 'POST' });
            if(!res.ok) throw new Error("Error en servidor");
            
            const data = await res.json();
            
            if(data.length === 0) {
                resDiv.innerHTML = 'El grafo ya parece coherente. No se infirieron nuevas relaciones.';
            } else {
                resDiv.innerHTML = `<span class="text-success fw-bold"><i class="fa-solid fa-plus me-1"></i>¡${data.length} nuevas conexiones!</span><br>Actualizando visualización...`;
                await loadGraph();
            }
        } catch(e) {
            resDiv.innerHTML = '<span class="text-danger">Error al ejecutar razonamiento.</span>';
        } finally {
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);
        }
    }

    // --- 3. GRAFO PRINCIPAL ---
    async function reloadGraph() { await loadGraph(); }

    async function loadGraph() {
        try {
            const res = await fetch('/api/graph');
            const data = await res.json();
            renderGraph(data);
        } catch(e) { console.error("Error cargando grafo", e); }
    }

    function renderGraph(data) {
        const nodes = new vis.DataSet(data.nodes.map(n => ({
            id: n.id, label: n.label, group: n.group, title: `<b>${n.label}</b><br>Cat: ${n.group}`
        })));
        
        const edges = new vis.DataSet(data.edges.map(e => ({
            from: e.from, to: e.to, label: e.label, 
            arrows: 'to',
            dashes: e.label.startsWith('INFERRED'), 
            color: e.label.startsWith('INFERRED') ? '#f59e0b' : '#64748b' 
        })));
        
        const container = document.getElementById('network-container');
        const options = {
            nodes: { shape: 'dot', size: 20, font: { size: 14, color: '#e2e8f0', face: 'Outfit' }, borderWidth: 2, shadow: true },
            edges: { width: 1, font: { size: 10, align: 'middle', color: '#94a3b8', strokeWidth: 0 }, smooth: { type: 'continuous' } },
            groups: { 
                "Concepto": { color: { background: '#f59e0b', border: '#b45309' } }, 
                "Actor": { color: { background: '#3b82f6', border: '#1d4ed8' } }, 
                "Sintoma": { color: { background: '#ef4444', border: '#b91c1c' } } 
            },
            physics: { forceAtlas2Based: { gravitationalConstant: -50, centralGravity: 0.005, springLength: 100, springConstant: 0.08 }, maxVelocity: 50, solver: 'forceAtlas2Based', timestep: 0.35, stabilization: { iterations: 150 } },
            interaction: { hover: true, tooltipDelay: 200 }
        };
        
        if(network) { network.setData({nodes, edges}); } else { network = new vis.Network(container, {nodes, edges}, options); }
    }

    // --- 4. CHAT Y LÓGICA DE INTERACCIÓN ---

    function handleEnter(e) { if(e.key === 'Enter') sendChat(); }

    // Formateador profesional de respuesta IA
    function formatAIResponse(text) {
        // Regex para capturar [[Concepto]]
        let formatted = text.replace(/\[\[(.*?)\]\]/g, (match, concept) => {
            // Escapar comillas simples por seguridad para el onclick
            const safeConcept = concept.replace(/'/g, "\\'");
            return `<span class="concept-pill" onclick="openConceptModal('${safeConcept}')" title="Clic para explorar '${concept}'">
                        <i class="fa-solid fa-circle-nodes"></i> ${concept}
                    </span>`;
        });
        
        // Formateo de Referencias (Ref: ID)
        formatted = formatted.replace(/\(Ref: (.*?)\)/g, 
            '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 fw-normal font-monospace ms-1" style="font-size:0.7em; cursor:help;" title="Fragmento ID: $1">REF:$1</span>');
        
        // Markdown básico
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    async function sendChat() {
        const input = document.getElementById('userPrompt');
        const text = input.value.trim();
        if(!text) return;

        appendMessage('user', text);
        input.value = '';
        const loadingId = showTyping();

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            if(!res.ok) throw new Error("Error en el servidor");
            const data = await res.json();
            
            removeTyping(loadingId);
            
            let content = formatAIResponse(data.response);
            
            if(data.context_used && data.context_used.length > 0) {
                content += `
                <div class="mt-3 pt-2 border-top small text-muted">
                    <details>
                        <summary style="cursor:pointer; font-weight:bold; font-size:0.8rem">
                            <i class="fa-solid fa-book-open me-1"></i> Fuentes Consultadas (${data.context_used.length})
                        </summary>
                        <div class="mt-2 p-2 bg-light rounded fst-italic border">
                            ${data.context_used.map(c => `<div class="mb-2"><i class="fa-solid fa-caret-right me-1 opacity-50"></i>${c}</div>`).join('')}
                        </div>
                    </details>
                </div>`;
            }

            appendMessage('assistant', content);

        } catch(e) {
            removeTyping(loadingId);
            appendMessage('assistant', `<span class="text-danger">Error: ${e.message}</span>`);
        }
    }

    function appendMessage(role, htmlContent) {
        const div = document.createElement('div');
        div.className = `d-flex align-items-start mb-3 ${role === 'user' ? 'justify-content-end' : ''}`;
        const bgClass = role === 'user' ? 'bg-primary text-white' : 'bg-white border text-dark';
        div.innerHTML = `<div class="${bgClass} rounded p-3 shadow-sm" style="max-width: 85%;">${htmlContent}</div>`;
        const area = document.getElementById('chatArea');
        area.append(div);
        area.scrollTop = area.scrollHeight;
    }

    function showTyping() {
        const id = 'typing-' + Date.now();
        const area = document.getElementById('chatArea');
        const div = document.createElement('div');
        div.id = id;
        div.className = "d-flex align-items-start mb-3";
        div.innerHTML = `
            <div class="bg-white border rounded p-3 shadow-sm text-muted fst-italic">
                <i class="fa-solid fa-circle-notch fa-spin me-2"></i> Consultando grafo...
            </div>`;
        area.append(div);
        area.scrollTop = area.scrollHeight;
        return id;
    }

    function removeTyping(id) { const el = document.getElementById(id); if(el) el.remove(); }

    // --- 5. LÓGICA DE MODAL DEEP DIVE (SUB-GRAFO) ---
    async function openConceptModal(conceptName) {
        // Abrir Modal
        const modalEl = document.getElementById('conceptModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
        // Reset UI
        document.getElementById('conceptModalTitle').innerText = conceptName;
        document.getElementById('conceptLoading').classList.remove('d-none');
        
        try {
            // Fetch Subgrafo
            const encodedName = encodeURIComponent(conceptName);
            const res = await fetch(`/api/graph/concept/${encodedName}`);
            
            if(!res.ok) throw new Error("No se pudo cargar la estructura");
            
            const data = await res.json();
            currentSubGraphData = data; // Guardar para exportar
            
            renderConceptGraph(data, conceptName);
            
        } catch(e) {
            console.error(e);
            document.getElementById('conceptModalTitle').innerText = "Error cargando datos: " + conceptName;
        } finally {
            document.getElementById('conceptLoading').classList.add('d-none');
        }
    }

    function renderConceptGraph(data, centerNodeId) {
        const container = document.getElementById('conceptNetwork');
        
        const nodes = new vis.DataSet(data.nodes.map(n => {
            const isCenter = n.id === centerNodeId;
            return {
                id: n.id,
                label: n.label,
                // Nodo central naranja, vecinos azules
                color: isCenter ? { background: '#f59e0b', border: '#b45309' } : { background: '#3b82f6', border: '#1d4ed8' },
                size: isCenter ? 30 : 20,
                font: { size: isCenter ? 16 : 14, color: '#e2e8f0', face: 'Outfit', strokeWidth: 3, strokeColor: '#000000' },
                shadow: true,
                shape: 'dot'
            };
        }));

        const edges = new vis.DataSet(data.edges.map(e => ({
            from: e.from, 
            to: e.to, 
            label: e.label,
            font: { align: 'middle', size: 10, color: '#94a3b8' },
            arrows: 'to',
            color: { color: '#64748b', opacity: 0.6 }
        })));

        const options = {
            physics: {
                forceAtlas2Based: { gravitationalConstant: -100, springLength: 120 },
                solver: 'forceAtlas2Based',
                stabilization: { iterations: 100 }
            },
            interaction: { zoomView: true, dragView: true }
        };

        if(conceptNetworkInstance) {
            conceptNetworkInstance.destroy();
        }
        conceptNetworkInstance = new vis.Network(container, { nodes, edges }, options);
    }

    // --- 6. EXPORTAR DATOS ---
    function exportSubGraph(format) {
        if(!currentSubGraphData) return alert("No hay datos para exportar");

        let content = "";
        let filename = `graph_export_${Date.now()}`;
        let mime = "text/plain";

        if (format === 'json') {
            content = JSON.stringify(currentSubGraphData, null, 2);
            filename += ".json";
            mime = "application/json";
        } else if (format === 'csv') {
            content = "ID,Label,Category\n" + 
                currentSubGraphData.nodes.map(n => `"${n.id}","${n.label}","${n.group}"`).join("\n");
            filename += ".csv";
            mime = "text/csv";
        }

        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}